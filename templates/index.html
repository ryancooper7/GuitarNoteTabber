<!--MediaRecorder API examples referenced in learning to
take user audio input-->

<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel = "stylesheet" type = "text/css" href = "{{url_for('static',filename='stylesheets/styles.css')}}">
</head>
<body>
  <div id = "div1">
  <h1>GuitarNoteTabber</h1>
  <h2>Instructions</h2>
  <p>Press the button to begin and then play individual guitar notes.
    Press the button again to stop and the names of the notes will be returned.
  </p>
  <button id = "record">Begin Recording</button>
  <audio id = "player" controls></audio>
  <button onclick="do_ajax()">Find Notes Played</button>
  <p id ="new-text">
  </p>

  </div>
  <script>
    var recordButton, recorder;
    var clicked = 0;
    var data;

    window.onload = function () {
      recordButton = document.getElementById('record');

      //Get permission to use computer microphone
      navigator.mediaDevices.getUserMedia({
        audio: true
      })
      .then(function (stream) {
        //Use MediaRecorder API to record audio stream from getUserMedia
        recorder = new MediaRecorder(stream);

        recordButton.addEventListener('click', toggleRecording);
        recorder.addEventListener('dataavailable', onFinishedRecording);
      });
    };

    function do_ajax() {
      var req = new XMLHttpRequest();
      req.onreadystatechange = function() {
        if (this.readyState==4 && this.status == 200) {
          document.getElementById("new-text").innerHTML = this.responseText;
        }
      };
      req.open("POST", "/index/", true);
      req.send(data);
    }

    //Starts or stops recording and modifies button text
    function toggleRecording() {
      if (clicked == 0) {
        recorder.start();
        recordButton.innerText = "Stop Recording";
        clicked = 1;
      }
      else {
        recorder.stop();
        clicked = 0;
        recordButton.innerText = "Start Recording"
      }
    }

    //Recieves a "dataavailable" signal upon the recorder being stopped
    //and then takes the recorded data and creates a URL object to store
    //in the HTML audio element
    function onFinishedRecording(e) {
      var audio = document.getElementById('player');
      data = e.data;
      audio.src = URL.createObjectURL(e.data);
      console.log(e.data);
    }
  </script>
</body>
